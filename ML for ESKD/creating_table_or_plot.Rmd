---
title: "creating_plot"
author: "Daniel Christiadi"
date: "04/07/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'asis', collapse = TRUE)
libraries <- c("tidyverse", "data.table", "skimr", "gt", "gtsummary", 
               "ggsci", "patchwork")
installed <- installed.packages()[,'Package']
new.libs <- libraries[!(libraries %in% installed)]
if(length(new.libs)) install.packages(new.libs,repos="http://cran.csiro.au",
                                      dependencies=TRUE)
lib.ok <- sapply(libraries, require, character.only=TRUE)
```

```{r C-index}
locf2_dt <- fread("cv_lm_locf_performance_escl_2.gz")
locf5_dt <- fread("cv_lm_locf_performance_excl_5.gz")
lme2_dt <- fread("cv_lm_lme_performance_2.gz")
lme5_dt <- fread("cv_lm_lme_performance_5.gz")
lme2poly_dt <- fread("cv_lm_lme_poly_performance_2.gz")
lme5poly_dt <- fread("cv_lm_lme_poly_performance_5.gz")

plot1 <- locf2_dt %>% 
    select(-(brier_eskd:fold)) %>% 
    arrange(LM) %>% 
    mutate(LM = as_factor(LM)) %>% 
    pivot_longer(cols = c("error_eskd", "error_death"),
                 names_to = "error") %>% 
    mutate(error = factor(error, levels = c("error_eskd", "error_death"),
                          labels = c("ESKD", "Death"))) %>% 
    ggplot(aes(x = error, y = value, fill = error)) + geom_boxplot() +
    facet_grid(~ LM) + scale_fill_nejm() + 
    labs(title = "Error Rate (1 - Harrell's C-index) per Landmark with LOCF Prediction Horizon 2 years", 
         y = "Error Rate (%)") + 
    theme_bw() + theme(axis.title.x = element_blank(), 
                       legend.title = element_blank()) + 
    scale_y_continuous(breaks = seq(0, 30, 5), limits = c(0,30))

plot2 <- lme2_dt %>% 
    select(-(brier_eskd:fold)) %>% 
    arrange(LM) %>% 
    mutate(LM = as_factor(LM)) %>% 
    pivot_longer(cols = c("error_eskd", "error_death"),
                 names_to = "error") %>% 
    mutate(error = factor(error, levels = c("error_eskd", "error_death"),
                          labels = c("ESKD", "Death"))) %>%  
    ggplot(aes(x = error, y = value, fill = error)) + geom_boxplot() +
    facet_grid(~ LM) + scale_fill_nejm() + 
    labs(title = "Error Rate (1 - Harrell's C-index) per Landmark with Mixed Model Prediction Horizon 2 years", 
         y = "Error Rate (%)") + 
    theme_bw() + theme(axis.title.x = element_blank(), 
                       legend.title = element_blank()) + 
    scale_y_continuous(breaks = seq(0, 30, 5), limits = c(0,30))

plot3 <- lme2poly_dt %>% 
    select(-(brier_eskd:fold)) %>% 
    arrange(LM) %>% 
    mutate(LM = as_factor(LM)) %>% 
    pivot_longer(cols = c("error_eskd", "error_death"),
                 names_to = "error") %>% 
    mutate(error = factor(error, levels = c("error_eskd", "error_death"),
                          labels = c("ESKD", "Death"))) %>%  
    ggplot(aes(x = error, y = value, fill = error)) + geom_boxplot() +
    facet_grid(~ LM) + scale_fill_nejm() + 
    labs(title = "Error Rate (1 - Harrell's C-index) per Landmark with Mixed Model (poly) Prediction Horizon 2 years", 
         y = "Error Rate (%)") + 
    theme_bw() + theme(axis.title.x = element_blank(), 
                       legend.title = element_blank()) + 
    scale_y_continuous(breaks = seq(0, 30, 5), limits = c(0,30))

plot1 + plot2 + plot3 + guide_area() + plot_layout(ncol = 2, guides = "collect")

dt1 <- locf2_dt %>% 
    select(LM:N) %>% 
    mutate(method = "LOCF") %>% 
    group_by(LM) %>% 
    mutate(median_subject = median(N)) %>% 
    ungroup() %>% 
    select(LM, method, median_subject) %>% distinct()

lme2_dt %>% 
    select(LM:N) %>% 
    mutate(method = "LME") %>% 
    group_by(LM) %>% 
    mutate(median_subject = median(N)) %>% 
    ungroup() %>% 
    select(LM, method, median_subject) %>% distinct()

lme2poly_dt %>% 
    select(LM:N) %>% 
    mutate(method = "LME") %>% 
    group_by(LM) %>% 
    mutate(median_subject = median(N)) %>% 
    ungroup() %>% 
    select(LM, method, median_subject) %>% distinct()

```

```{r}
plot1 <- locf5_dt %>% 
    select(-(brier_eskd:fold)) %>% 
    arrange(LM) %>% 
    mutate(LM = as_factor(LM)) %>% 
    pivot_longer(cols = c("error_eskd", "error_death"),
                 names_to = "error") %>% 
    mutate(error = factor(error, levels = c("error_eskd", "error_death"),
                          labels = c("ESKD", "Death"))) %>%  
    ggplot(aes(x = error, y = value, fill = error)) + geom_boxplot() +
    facet_grid(~ LM) + scale_fill_nejm() + 
    labs(title = "Error Rate (1 - Harrell's C-index) per Landmark with LOCF Prediction Horizon 5 years", 
         y = "Error Rate (%)") + 
    theme_bw() + theme(axis.title.x = element_blank(), 
                       legend.title = element_blank()) + 
    scale_y_continuous(breaks = seq(0, 30, 5), limits = c(0,30))

plot2 <- lme5_dt %>% 
    select(-(brier_eskd:fold)) %>% 
    arrange(LM) %>% 
    mutate(LM = as_factor(LM)) %>% 
    pivot_longer(cols = c("error_eskd", "error_death"),
                 names_to = "error") %>% 
    mutate(error = factor(error, levels = c("error_eskd", "error_death"),
                          labels = c("ESKD", "Death"))) %>%  
    ggplot(aes(x = error, y = value, fill = error)) + geom_boxplot() +
    facet_grid(~ LM) + scale_fill_nejm() + 
    labs(title = "Error Rate (1 - Harrell's C-index) per Landmark with Mixed Model Prediction Horizon 5 years", 
         y = "Error Rate (%)") + 
    theme_bw() + theme(axis.title.x = element_blank(), 
                       legend.title = element_blank()) + 
    scale_y_continuous(breaks = seq(0, 30, 5), limits = c(0,30))

plot3 <- lme5poly_dt %>% 
    select(-(brier_eskd:fold)) %>% 
    arrange(LM) %>% 
    mutate(LM = as_factor(LM)) %>% 
    pivot_longer(cols = c("error_eskd", "error_death"),
                 names_to = "error") %>% 
    mutate(error = factor(error, levels = c("error_eskd", "error_death"),
                          labels = c("ESKD", "Death"))) %>%  
    ggplot(aes(x = error, y = value, fill = error)) + geom_boxplot() +
    facet_grid(~ LM) + scale_fill_nejm() + 
    labs(title = "Error Rate (1 - Harrell's C-index) per Landmark with Mixed Model (poly) Prediction Horizon 5 years", 
         y = "Error Rate (%)") + 
    theme_bw() + theme(axis.title.x = element_blank(), 
                       legend.title = element_blank()) + 
    scale_y_continuous(breaks = seq(0, 30, 5), limits = c(0,30))

plot1 + plot2 + plot3 + guide_area() + plot_layout(ncol = 2, guides = "collect")
```

