---
title: "Machine Learning for Prediction of End Stage Kidney Disease"
author: "Daniel Christiadi"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r Library Preparation, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'asis', collapse = TRUE)
libraries <- c('readxl', 'tidyverse', 'factoextra', 'cluster', 'dendextend', 
               'ggExtra', 'patchwork','fasttime', 'broom', 'outliers', 'skimr', 
               'plotly', 'heatmaply', 'shiny', 'iml', 'data.table', 'reticulate',
               'gt', 'gtsummary')
installed <- installed.packages()[,'Package']
new.libs <- libraries[!(libraries %in% installed)]
if(length(new.libs)) install.packages(new.libs,repos="http://cran.csiro.au",
                                      dependencies=TRUE)
lib.ok <- sapply(libraries, require, character.only=TRUE)
input <<- list(egfryears= c(2, 3, 4, 5), minegfrobs= c(2, 4, 6, 9, 12, 15), test_pc= 20)
outcomes <<- list('eskd' = c('non_eskd', 'eskd'), 'death' = c('alive', 'death')) 
thresh_chisq <<- 0.999999999
features <<- c('height', 'weight', 'bmi', 'sit_dia', 'sit_sys', 'sit_hr', 'sta_dia',
               'sta_sys', 'sta_hr', 'diff_dia', 'diff_sys', 'glucose', 'hba1c',
               'haemoglobin', 'haematocrit', 'rbc', 'rdw', 'mch', 'mchc', 'mcv', 'wcc',
               'neutrophils', 'lymphocytes', 'eosinophils', 'monocytes', 'basophils', 'platelet',
               'ferritin', 'iron', 'transferrin', 'tsat', 'calcium', 'phosphate',
               'pth', 'caphos_product', 'alkphos', 'magnesium', 'sodium', 'potassium',
               'chloride', 'bicarbonate', 'alt', 'albumin', 'ggt', 'bilirubin', 'globulin',
               'protein', 'cholesterol', 'triglycerides', 'ldl', 'hdl', 'tsh', 'creatinine',
               'egfr', 'urate', 'urea', 'crp', 'esr', 'protcreat_ratio',
               'timedprotein', 'albcreat_ratio')

primary_cluster <- c('crp', 'urea', 'egfr', 'creatinine', 'protein', 'globulin',
                     'bilirubin', 'ggt', 'albumin', 'alt', 'bicarbonate', 'chloride', 'potassium',
                     'sodium', 'magnesium', 'alkphos', 'caphos_product', 'phosphate', 'calcium', 
                     'platelet', 'basophils', 'monocytes', 'eosinophils', 'lymphocytes', 
                     'neutrophils', 'wcc', 'mcv', 'mchc', 'mch', 'rdw', 'rbc', 'haematocrit', 
                     'haemoglobin', 'glucose')

secondary_cluster <- c('albcreat_ratio', 'timedprotein', 'protcreat_ratio', 
                       'esr', 'urate', 'tsh','hdl', 'ldl', 'triglycerides', 
                       'cholesterol', 'pth', 'tsat', 'transferrin', 'iron', 
                       'ferritin', 'hba1c', 'diff_sys', 'diff_dia', 'sta_hr', 
                       'sta_sys', 'sta_dia', 'sit_hr', 'sit_sys', 
                       'sit_dia', 'bmi', 'weight', 'height')
```

## Baseline characteristics
```{r, message=FALSE}
outcomes_dt <- fread("outcome_data.gz")
outcomes_dt %>% 
  select(age_init, gender, gn, dkd, htn, date_eskd, date.death) %>% 
  mutate(death = !is.na(date.death),
         eskd = !is.na(date_eskd)) %>% 
  select(-date.death, -date_eskd) %>% tbl_summary(sort = gn ~ "frequency")
```

## Distribution of Data Points
```{r, message=FALSE}
features_dt <- fread("features_data.gz")

features_dt %>% 
    select(test) %>% 
    tbl_summary(sort = everything() ~ "frequency")
```
## Heatmap of Data Density
```{r echo=FALSE, message=FALSE, eval=FALSE}
id_dt <- outcomes_dt %>% select(id)
setkey(id_dt, id)

melted <- readRDS("melted.RDS")
setkey(melted, id)

for (feature in features){
  m <- melted[test == feature]
    obs <- m[, .N, by = id]
    setnames(obs, old = 'N', new = feature)
    setkey(obs, id)
    id_dt <- obs[id_dt]
}

id_dt[, id := NULL]
id_dt[is.na(id_dt)] <- 0

heatmap_breaks<-c(0, 1, 2, 5, 10, 20, 50, 100, 200, 500, 1000, 2000, 5000, 10000)
heatmaply(x = t(as.matrix(id_dt)), ylab = 'Features', xlab = 'Patients', 
          main = 'Data Density of Clinico-Pathological Data of All Patients',
          dist_method = 'manhattan', hclust_method = 'ward.D2',
          Rowv = TRUE, Colv = TRUE, dendrogram = 'both', 
          showticklabels = c(FALSE, TRUE), 
          scale_fill_gradient_fun = scale_fill_viridis(trans='sqrt', 
                                                       breaks=heatmap_breaks,
                                                       labels=heatmap_breaks, 
                                                       option = 'B', 
                                                       direction = -1,
                                                       na.value='white')) 
```


# tsfresh <- import("tsfresh")
# 
# for (feature in c('creatinine')){
#     dt <- out_dt_1y_save[test == feature]
#     setnames(dt, 'value', feature)
#     
#     f <- as.data.table(tsfresh$extract_features(dt, column_id = 'id', column_sort = 'relyear'))
#     f
# }



```

```{r, echo=FALSE, eval=FALSE, message=FALSE}

comprehensive_setting <- tsfresh$feature_extraction$ComprehensiveFCParameters()


```







