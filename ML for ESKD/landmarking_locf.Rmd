---
title: "landmarking_locf"
author: "Daniel Christiadi"
date: "Compiled on `r format(Sys.time(), '%d %B, %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'asis', collapse = TRUE)
libraries <- c("tidyverse", "data.table", "skimr", "nlme", "dynpred", "prodlim", 
               "mice", "randomForestSRC", "pec", "ggsci")
installed <- installed.packages()[,'Package']
new.libs <- libraries[!(libraries %in% installed)]
if(length(new.libs)) install.packages(new.libs,repos="http://cran.csiro.au",
                                      dependencies=TRUE)
lib.ok <- sapply(libraries, require, character.only=TRUE)

cross_val <- 5
seed <- 7
predict_horizon <- 2 #5
landmark <- c(0.5, 1, 1.5, 2, 2.5, 3)

longi_cov <- c("albumin", "alkphos", "bicarb", "calcium", "chloride", 
                "egfr", "glucose", "haemoglobin", "phosphate", "platelet", 
                "potassium", "sodium", "wcc") #"urea"

base_cov <- c("sex", "age_init", "gn_cat") #"value_egfr_init", 
```

```{r k-fold}
dt <- read_rds("dense3.RDS")

dt <- dcast(dt, 
      id + relyear + value_egfr_init + sex + age_init + gn_cat + time_compete +
          status_compete ~ test, value.var = "value")

dt <- dt %>% 
    mutate(status_compete_num = case_when(
      status_compete == "censored" ~ 0,
      status_compete == "eskd" ~ 1,
      TRUE ~ 2
    )) %>% 
    relocate(status_compete_num, .after = status_compete) %>% 
    mutate(sex = factor(sex, levels = c("Female", "Male")),
           gn_cat = factor(gn_cat, levels = c("no", "yes")))

set.seed(seed)

folds <- dt %>% 
    select(id, value_egfr_init:status_compete) %>% 
    distinct(id, .keep_all = TRUE) %>% 
    rsample::vfold_cv(v = cross_val, strata = "status_compete")
```

```{r cross validation LOCF}
cv_vimp <- NULL
cv_cif <- NULL
cv_performance <- NULL

for (fold in 1:nrow(folds)){
    print(glue::glue("Current fold: {fold}"))
    
    train_id <- folds$splits[[fold]] %>% 
        rsample::analysis() %>% 
        pull(id)
    
    test_id <- folds$splits[[fold]] %>% 
        rsample::assessment() %>% 
        pull(id)
    
    train_dt <- dt[id %chin% train_id,]
    test_dt <- dt[id %chin% test_id,]
    
    long_train <- train_dt %>%
        select(id, relyear, !!longi_cov)
 
    ## imputing covariates at relyear == 0   
    impute_dt <- long_train %>% 
        filter(relyear == 0)
    temp_dt <- mice(impute_dt, m = 1, maxit = 50, method = "pmm", seed = seed)
    impute_dt <- complete(temp_dt)

    train_dt <- impute_dt %>% 
        bind_rows(long_train) %>% 
        arrange(id) %>% 
        distinct(id, relyear, .keep_all = TRUE) %>% 
        fill(!!longi_cov) %>% 
        left_join(select(train_dt, id:status_compete_num),
                  by = c("id", "relyear")) %>% 
        arrange(id, relyear)
    
    train_super_dt <- NULL
    for (i in seq_along(landmark)) {
        temp <- cutLM(data = train_dt, outcome = list(time = "time_compete",
                                              status = "status_compete_num"),
                      LM = landmark[i], horizon = landmark[i] + predict_horizon,
                      covs = list(fixed = base_cov, varying = longi_cov),
                      format = "long", id = "id", rtime = "relyear") 
        train_super_dt <- rbind(train_super_dt, temp)
    }

    test_super_dt <- NULL

    for (i in seq_along(landmark)) {
        temp <- cutLM(data = test_dt, outcome = list(time = "time_compete",
                                              status = "status_compete_num"),
                      LM = landmark[i], horizon = landmark[i] + predict_horizon,
                      covs = list(fixed = base_cov, varying = longi_cov),
                      format = "long", id = "id", rtime = "relyear") 
      test_super_dt <- rbind(test_super_dt, temp)
    }
    
    model_vimp <- NULL

    model_cif <- NULL

    model_performance <- NULL

    for (lmx in landmark){
        print(glue::glue("Processing landmark: {lmx}"))
    
        train_lm <- train_super_dt %>% 
            filter(LM == lmx)
    
        test_lm <- test_super_dt %>% 
            filter(LM == lmx) %>% 
            drop_na()
    
        model_formula <- as.formula(str_c("Surv(time_compete, status_compete_num)",
                       str_c(c(base_cov, longi_cov), collapse = " + "), 
                       sep = "~"))
    
        tune_rsf <- tune.rfsrc(model_formula, data = train_lm, mtryStart = 1, 
               ntreeTry = 500, nodesizeTry = c(1:9, seq(10, 100, 5)),
               sampsize = 0.623 * (nrow(train_lm)), stepFactor = 1.5)
    
        rsf_model <- rfsrc(formula = model_formula, data = train_lm, ntree = 1000, 
              splitrule = "logrankCR", importance = TRUE, statistics = TRUE, 
              mtry = tune_rsf$optimal[[2]], nodesize = tune_rsf$optimal[[1]])
    
        vimp_temp <- data.table(LM = lmx,
                            event = c("eskd", "death"))
    
        vimp_temp <- cbind(vimp_temp, 100*t(rsf_model$importance))
    
        model_vimp <- rbind(model_vimp, vimp_temp)
    
        column_cif <- sindex(jump.times = rsf_model$time.interest, 
                    eval.times = (lmx + predict_horizon))
    
        rsf_prediction <- predict.rfsrc(object = rsf_model,
                             newdata = test_lm, na.action = "na.omit")
    
        cif_temp <- data.table(id = test_lm$id,
                           LM = lmx,
                           eskd_cif = rsf_prediction$cif[, column_cif, 1],
                           death_cif = rsf_prediction$cif[, column_cif, 2])
    
        model_cif <- rbind(model_cif, cif_temp)
    
        brier_eskd <- pec(rsf_model, formula = model_formula, data = test_lm,
                         cause = 1)
    
        brier_death <- pec(rsf_model, formula = model_formula, data = test_lm,
                         cause = 2)
    
        error_temp <- unname(apply(rsf_prediction$err.rate, 2, sum, na.rm = TRUE))
        
        performance_temp <- data.table(LM = lmx,
                                   error_eskd = 100 * error_temp[1],
                                   error_death = 100 * error_temp[2],
                                   brier_eskd = crps(brier_eskd)[2],
                                   brier_death = crps(brier_death)[2])
    
        model_performance <- rbind(model_performance, performance_temp)
    }
    
    model_vimp$fold <- fold
    cv_vimp <- rbind(cv_vimp, model_vimp)
    
    model_cif$fold <- fold
    cv_cif <- rbind(cv_cif, model_cif)
    
    model_performance$fold <- fold
    cv_performance <- rbind(cv_performance, model_performance)
}
```

```{r cv-results}
cv_performance %>% 
    select(-(brier_eskd:fold)) %>% 
    arrange(LM) %>% 
    mutate(LM = as_factor(LM)) %>% 
    pivot_longer(cols = c("error_eskd", "error_death"),
                 names_to = "error") %>% 
    mutate(error = factor(error, levels = c("error_eskd", "error_death"),
                          labels = c("ESKD", "Death"))) %>%  
    ggplot(aes(x = error, y = value, fill = error)) + geom_boxplot() +
    facet_grid(~ LM) + scale_fill_nejm() + 
    labs(title = "Error Rate (1 - Harrell's C-index) per Landmark Prediction Horizon 2 years exclude Urea and Initial eGFR", y = "Error Rate (%)") + 
    theme_bw() + theme(axis.title.x = element_blank(), 
                       legend.title = element_blank())

cv_performance %>% 
    select(-(error_eskd:error_death), -fold) %>% 
    arrange(LM) %>% 
    mutate(LM = as_factor(LM)) %>% 
    pivot_longer(cols = c("brier_eskd", "brier_death"),
                 names_to = "brier") %>% 
    mutate(brier = factor(brier, levels = c("brier_eskd", "brier_death"),
                          labels = c("ESKD", "Death"))) %>%    
    ggplot(aes(x = brier, y = value, fill = brier)) + geom_boxplot() +
    facet_grid(~ LM) + scale_fill_nejm() + 
    labs(title = "Integrated Brier Score per Landmark Prediction Horizon 2 years exclude Urea and Initial eGFR", 
         y = "Brier Score") + 
    theme_bw() + theme(axis.title.x = element_blank(), 
                       legend.title = element_blank())

cv_vimp %>% 
    filter(event == "eskd") %>% 
    select(-event, -fold) %>% 
    arrange(LM) %>% 
    mutate(LM = factor(LM)) %>% 
    pivot_longer(cols = (sex:wcc), names_to = "covariates") %>% 
    ggplot(aes(x = fct_reorder(covariates,value), y = value, 
               fill = covariates)) + 
    geom_boxplot() + 
    coord_flip() + 
    facet_grid(~ LM) + 
    labs(title = "Variable Importance for 2 years ESKD Prediction per Landmark exclude Urea and Initial eGFR",
         y = "Value") +  
    theme_bw() + theme(axis.title.y = element_blank(), 
                       legend.position = "none")

cv_vimp %>% 
    filter(event == "death") %>% 
    select(-event, -fold) %>% 
    arrange(LM) %>% 
    mutate(LM = factor(LM)) %>% 
    pivot_longer(cols = (sex:wcc), names_to = "covariates") %>% 
    ggplot(aes(x = fct_reorder(covariates,value), y = value, 
               fill = covariates)) + 
    geom_boxplot() + 
    coord_flip() + 
    facet_grid(~ LM) + 
    labs(title = "Variable Importance for 2 years Death Prediction per Landmark exclude Urea and Initial eGFR",
         y = "Value") +  
    theme_bw() + theme(axis.title.y = element_blank(), 
                       legend.position = "none")

```

